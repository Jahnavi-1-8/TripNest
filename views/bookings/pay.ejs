<% layout('layouts/bolierplate') %>

<div class="container-xl my-5">
  <div class="row gx-4">
    <!-- Left: booking form -->
    <div class="col-12 col-lg-7">
      <div class="card mb-4">
        <div class="card-body">
          <h4 class="card-title mb-3">Reserve — <%= listing.title %></h4>
          <form id="bookingForm" action="/bookings/<%= listing._id %>/pay" method="POST">
            <div class="row">
              <div class="col-12 col-md-6 mb-3">
                <label class="form-label">Check-in</label>
                <input type="date" name="checkIn" class="form-control" required />
              </div>
              <div class="col-12 col-md-6 mb-3">
                <label class="form-label">Check-out</label>
                <input type="date" name="checkOut" class="form-control" required />
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Guests</label>
              <input type="number" name="guests" min="1" value="1" class="form-control" />
            </div>
            <div class="mb-3">
              <button type="submit" class="btn btn-success">Pay & Reserve</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Right: summary card -->
    <div class="col-12 col-lg-5">
      <div class="card" style="border-radius:12px;">
        <% const imgUrl = listing.image && listing.image.url ? listing.image.url : '/images/default.jpg' %>
        <div class="card-body">
          <div class="d-flex gap-3 align-items-start">
            <img src="<%= imgUrl %>" alt="thumb" style="width:84px;height:84px;object-fit:cover;border-radius:8px;"/>
            <div class="flex-grow-1">
              <h6 class="mb-1"><%= listing.title %></h6>
              <div class="text-muted small">₹<%= Number(listing.price).toLocaleString('en-IN') %> / night</div>
            </div>
          </div>

          <hr/>

          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="small text-muted">Dates</div>
              <div id="summary-dates">—</div>
            </div>
            <div><a href="#" class="btn btn-sm btn-outline-secondary">Change</a></div>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="small text-muted">Guests</div>
              <div id="summary-guests">1 adult</div>
            </div>
            <div><a href="#" class="btn btn-sm btn-outline-secondary">Change</a></div>
          </div>

          <hr/>

          <h6 class="small text-muted">Price details</h6>
          <div class="d-flex justify-content-between">
            <div id="pd-label">1 night x ₹<span id="pd-rate"><%= listing.price %></span></div>
            <div>₹<span id="pd-subtotal"><%= listing.price %></span></div>
          </div>
          <div class="d-flex justify-content-between text-success">
            <div>Long stay discount</div>
            <div>-₹<span id="pd-discount">0.00</span></div>
          </div>
          <div class="d-flex justify-content-between text-muted mb-2">
            <div>Taxes</div>
            <div>₹<span id="pd-taxes">0.00</span></div>
          </div>

          <hr/>
          <div class="d-flex justify-content-between align-items-center">
            <div><strong>Total INR</strong></div>
            <div style="font-size:1.25rem;font-weight:600">₹<span id="pd-total"><%= listing.price %></span></div>
          </div>

          <div class="mt-3">
            <a href="#" id="price-breakdown-link" class="small">Price breakdown</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    const pricePerNight = parseFloat('<%= listing.price %>') || 0;
    const ciEl = document.querySelector('input[name="checkIn"]');
    const coEl = document.querySelector('input[name="checkOut"]');
    const guestsEl = document.querySelector('input[name="guests"]');

    const summaryDates = document.getElementById('summary-dates');
    const summaryGuests = document.getElementById('summary-guests');
    const pdRate = document.getElementById('pd-rate');
    const pdSubtotal = document.getElementById('pd-subtotal');
    const pdDiscount = document.getElementById('pd-discount');
    const pdTaxes = document.getElementById('pd-taxes');
    const pdTotal = document.getElementById('pd-total');

    function formatINR(n){ return n.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2}); }

    function calc(){
      let nights = 1;
      let datesText = '—';
      try{
        if (ciEl && coEl && ciEl.value && coEl.value){
          const ci = new Date(ciEl.value);
          const co = new Date(coEl.value);
          const diff = Math.round((co - ci)/(24*60*60*1000));
          if (!isNaN(diff) && diff > 0) nights = diff;
          const opts = { day:'numeric', month:'short', year:'numeric' };
          datesText = ci.toLocaleDateString('en-US', opts).replace(',','') + ' – ' + co.toLocaleDateString('en-US', opts).replace(',','');
        }
      }catch(e){ nights = 1; }

      const subtotal = +(pricePerNight * nights).toFixed(2);
      const discount = nights >= 7 ? +(subtotal * 0.10).toFixed(2) : 0.00;
      const taxes = +((subtotal - discount) * 0.05).toFixed(2);
      const total = +(subtotal - discount + taxes).toFixed(2);

      summaryDates.textContent = datesText;
      summaryGuests.textContent = (guestsEl && guestsEl.value ? guestsEl.value : 1) + ' adult';
      pdRate.textContent = formatINR(pricePerNight);
      pdSubtotal.textContent = formatINR(subtotal);
      pdDiscount.textContent = formatINR(discount);
      pdTaxes.textContent = formatINR(taxes);
      pdTotal.textContent = formatINR(total);
    }

    [ciEl, coEl, guestsEl].forEach(el => { if (el) el.addEventListener('change', calc); });
    calc();
  })();
</script>
