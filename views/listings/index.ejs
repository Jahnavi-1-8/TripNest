<% layout('layouts/bolierplate') %>
<style>
/* Container for all filters + toggle */
#filters {
    display: flex;
    flex-wrap: wrap;          /* Allows wrapping on very small screens */
    align-items: center;      /* Vertically center all items */
    gap: 1.5rem;              /* Space between filters and toggle */
    padding: 1rem 0;
}

/* Each filter box */
.filter {
    text-align: center;
    opacity: 0.7;
    cursor: pointer;
    flex: 0 0 auto;          /* Prevents filters from shrinking too much */
    transition: opacity 0.2s;
}

.filter:hover {
    opacity: 1;
}

.filter p {
    margin-top: 0.5rem;
    font-weight: 500;
}

/* Toggle switch container */
.toggle {
    margin-left: auto;       /* Push toggle to the far right */
    flex: 0 0 auto;
}

/* Responsive adjustments for very small screens */
@media (max-width: 768px) {
    #filters {
        flex-wrap: wrap;     /* Allow wrapping on small screens */
        gap: 1rem;
    }
    .toggle {
        margin-top: 1rem;    /* Move toggle below filters if it wraps */
        margin-left: 0;
    }
}


</style>
<div id="filters">
 <!-- Search moved to navbar for compact UI -->
 <div class="filter">
    <div><i class="fa-solid fa-fire"></i></div>
    <p> Trending</p>
 </div>
 <div class="filter">
    <div><i class="fa-solid fa-bed" ></i>
        <p>Rooms</p>
    </div>
 </div>
  <div class="filter">
    <div><i class="fa-solid fa-mountain-city" ></i>
        <p>Iconic Cities</p>
    </div>
 </div>
  <div class="filter">
    <div><i class="fa-solid fa-mountain" ></i>
        <p>Mountain</p>
    </div>
 </div>
  <div class="filter">
    <div><i class="fa-brands fa-fort-awesome" ></i>
        <p>Castle</p>
    </div>
 </div>
<div class="filter">
        <div><i class="fa-solid fa-umbrella-beach" ></i>
            <p>Beach</p>
        </div>
</div>
    <div class="filter">
        <div><i class="fa-solid fa-tree" ></i>
            <p>Cabin</p>
        </div>
    </div>
    <div class="filter">
        <div><i class="fa-solid fa-city" ></i>
            <p>Countryside</p>
        </div>
    </div>
    <div class="filter">
        <div><i class="fa-solid fa-igloo" ></i>
            <p>Igloo</p>
        </div>
    </div>
    <div class="filter">
        <div><i class="fa-solid fa-house" ></i>
            <p>Homes</p>
        </div>
    </div>
    <div class="filter">
        <div><i class="fa-solid fa-building" ></i>
            <p>Apartment</p>
        </div>
    </div>
    <div class="filter">
        <div><i class="fa-solid fa-tent" ></i>
            <p>Camping</p>
        </div>
    </div>
    <div class="filter">
        <div><i class="fa-regular fa-snowflake" ></i>
            <p>Snow</p>
        </div>
    </div>
    <div class="toggle">
    <div class="form-check-reverse form-switch">
  <input class="form-check-input" type="checkbox" role="switch" id="switchCheckDefault">
  <label class="form-check-label" for="switchCheckDefault">Display Total After Taxes</label>
</div>
    </div>
</div>
<div class="container my-5">
    <h1 class="mb-4 fw-bold"></h1>

    <% if (filters && filters.location && (!allListings || allListings.length === 0)) { %>
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>No results</strong> — we couldn't find any listings matching "<%= filters.location %>".
            <button type="button" class="btn-close" aria-label="Close" id="no-results-close"></button>
            <script>
                // when the user clicks the close button, go back to unfiltered listings
                document.addEventListener('DOMContentLoaded', function () {
                    const btn = document.getElementById('no-results-close');
                    if (!btn) return;
                    btn.addEventListener('click', function () { window.location = '/listings'; });
                });
            </script>
        </div>
    <% } %>

  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    <% for (let listing of allListings) { %>
      <div class="col">
        <a href="/listings/<%= listing._id %>" class="card-link text-decoration-none text-dark">
          <div class="card listing-card h-100 shadow-sm">
            
            <img 
              src="<%= listing.image && listing.image.url ? listing.image.url : 'https://via.placeholder.com/400x250?text=No+Image' %>" 
              class="card-img-top" 
              alt="<%= listing.title%>"
            >
            
            <div class="card-body d-flex flex-column">
              <h5 class="card-title mb-2"><%= listing.title %></h5>
              
              <p class="card-text flex-grow-1 text-muted">
                <%= listing.description %>
              </p>

              <p class="card-text mt-auto">
                <strong>
                 &#8377;<%= listing.price ? listing.price.toLocaleString('en-IN') : 'N/A' %>/night
                <!-- <i class="tax-info">+18% GST </i> -->
                </strong> · 
                <%= listing.location  %>, 
                <%= listing.country %>
              </p>

              <a href="/listings/<%= listing._id %>" class="btn btn-primary mt-2 w-100">View Details</a>
            </div>
          </div>
        </a>
      </div>
    <% } %>
  </div>
</div>
<script>
    // Prevent submitting completely empty searches; redirect to base listings instead
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('search-form');
        if (!form) return;
        form.addEventListener('submit', function (e) {
            const loc = (form.elements['location'] && form.elements['location'].value || '').trim();
            const checkin = (form.elements['checkin'] && form.elements['checkin'].value || '').trim();
            const checkout = (form.elements['checkout'] && form.elements['checkout'].value || '').trim();
            const guests = (form.elements['guests'] && form.elements['guests'].value || '').trim();
            if (!loc && !checkin && !checkout && !guests) {
                e.preventDefault();
                // navigate back to unfiltered listings
                window.location.href = '/listings';
            }
        });
            const clearBtn = document.getElementById('clear-search');
            if (clearBtn) {
                clearBtn.addEventListener('click', function () {
                    form.reset();
                    window.location.href = '/listings';
                });
            }
    });

        let taxSwitch=document.getElementById('switchCheckDefault');
    taxSwitch.addEventListener('change',function(){
        let prices=document.getElementsByClassName("card-text mt-auto");
        if(taxSwitch.checked){
            for(let i=0;i<prices.length;i++){
                let priceText=prices[i].innerHTML;
                let priceMatch=priceText.match(/₹([\d,]+)/);
                if(priceMatch){
                    let price=parseInt(priceMatch[1].replace(/,/g,''));
                    let taxedPrice=price*1.18;
                    prices[i].innerHTML=priceText.replace(/₹[\d,]+/,'₹'+taxedPrice.toLocaleString('en-IN',{maximumFractionDigits:2}));
                }
            }
        }else{
            for(let i=0;i<prices.length;i++){
                let priceText=prices[i].innerHTML;
                let priceMatch=priceText.match(/₹([\d,]+)/);
                if(priceMatch){
                    let price=parseInt(priceMatch[1].replace(/,/g,''));
                    let originalPrice=price/1.18;
                    prices[i].innerHTML=priceText.replace(/₹[\d,]+/,'₹'+originalPrice.toLocaleString('en-IN',{maximumFractionDigits:2}));
                }
            }
        }
    });
</script>